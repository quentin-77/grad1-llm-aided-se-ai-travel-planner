name: Build and Push Docker Image

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: {}

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read # å…è®¸ Checkout
    env:
      ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
      ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
      IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      NEXT_PUBLIC_AMAP_WEB_KEY: ${{ secrets.NEXT_PUBLIC_AMAP_WEB_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun ACR
        # ä»…åœ¨æ‰€æœ‰ ACR å¯†é’¥éƒ½å­˜åœ¨æ—¶æ‰è¿è¡Œ
        if: ${{ env.ACR_REGISTRY != '' && env.ACR_USERNAME != '' && env.ACR_PASSWORD != '' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWORD }}

      - name: Build and Pushjobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # æé†’ï¼šå¦‚å‰æ‰€è¿°ï¼Œæ¨é€ACRæ—¶å¯ä»¥ç§»é™¤è¿™è¡Œ
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ‚¨çš„æµ‹è¯•æ­¥éª¤ â–¼â–¼â–¼
      # ----------------------------------------------------
      - name: ğŸ§ª 1. è°ƒè¯• - æ£€æŸ¥ ACR å¯†é’¥
        if: ${{ secrets.ACR_REGISTRY != '' && secrets.ACR_USERNAME != '' && secrets.ACR_PASSWORD != '' }}
        run: echo "âœ… [SUCCESS] ACR ç›¸å…³çš„3ä¸ªå¯†é’¥éƒ½å·²æˆåŠŸè¯»å–ã€‚"

      - name: ğŸ§ª 2. è°ƒè¯• - æ£€æŸ¥ Supabase å¯†é’¥
        if: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL != '' && secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY != '' }}
        run: echo "âœ… [SUCCESS] Supabase ç›¸å…³çš„2ä¸ªå¯†é’¥éƒ½å·²æˆåŠŸè¯»å–ã€‚"

      - name: ğŸ§ª 3. è°ƒè¯• - æ£€æŸ¥é«˜å¾·åœ°å›¾å¯†é’¥
        if: ${{ secrets.NEXT_PUBLIC_AMAP_WEB_KEY != '' }}
        run: echo "âœ… [SUCCESS] é«˜å¾·åœ°å›¾å¯†é’¥å·²æˆåŠŸè¯»å–ã€‚"

      - name: ğŸš¨ 4. è°ƒè¯• - æ£€æŸ¥ ACR å¯†é’¥ (å¤±è´¥æ—¶)
        if: ${{ secrets.ACR_REGISTRY == '' || secrets.ACR_USERNAME == '' || secrets.ACR_PASSWORD == '' }}
        run: echo "âŒ [FAILED] ACR ç›¸å…³çš„å¯†é’¥ (REGISTRY, USERNAME, or PASSWORD) æœªèƒ½è¯»å–ã€‚"

      - name: ğŸš¨ 5. è°ƒè¯• - æ£€æŸ¥ Supabase å¯†é’¥ (å¤±è´¥æ—¶)
        if: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL == '' || secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY == '' }}
        run: echo "âŒ [FAILED] Supabase ç›¸å…³çš„å¯†é’¥æœªèƒ½è¯»å–ã€‚"
      # ----------------------------------------------------
      # â–²â–²â–² æµ‹è¯•æ­¥éª¤ç»“æŸ â–²â–²â–²
      # ----------------------------------------------------

      - name: Set up Node
        uses: actions/setup-node@v4
        # ... æ‚¨çš„å…¶ä½™æ–‡ä»¶ ...
        uses: docker/build-push-action@v6
        with:
          context: .
          # ä»…åœ¨æ‰€æœ‰ ACR å¯†é’¥éƒ½å­˜åœ¨æ—¶æ‰å°è¯•æ¨é€
          push: ${{ env.ACR_REGISTRY != '' && env.ACR_USERNAME != '' && env.ACR_PASSWORD != '' }}
          
          # æ ‡ç­¾ï¼šä¸€ä¸ªå”¯ä¸€çš„ (SHA) æ ‡ç­¾å’Œä¸€ä¸ª 'latest' æ ‡ç­¾
          tags: |
            ${{ env.ACR_REGISTRY != '' && env.ACR_NAMESPACE != '' && (env.IMAGE_NAME != '' || 'voyageai')
                && format('{0}/{1}/{2}:{3}', env.ACR_REGISTRY, env.ACR_NAMESPACE, env.IMAGE_NAME || 'voyageai', github.sha)
                || format('voyageai/local:{0}', github.sha) }}
            ${{ env.ACR_REGISTRY != '' && env.ACR_NAMESPACE != '' && (env.IMAGE_NAME != '' || 'voyageai')
                && format('{0}/{1}/{2}:latest', env.ACR_REGISTRY, env.ACR_NAMESPACE, env.IMAGE_NAME || 'voyageai')
                || 'voyageai/local:latest' }}
            
          # ç¼“å­˜
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
          # å…³é”®ä¿®å¤ï¼šåœ¨æ„å»ºæ—¶ä¼ å…¥ NEXT_PUBLIC_ å˜é‡
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ env.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ env.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            NEXT_PUBLIC_AMAP_WEB_KEY=${{ env.NEXT_PUBLIC_AMAP_WEB_KEY }}

      - name: Print image reference
        run: |
          echo "Pushed: ${{ env.ACR_REGISTRY != '' && env.ACR_NAMESPACE != '' && (env.IMAGE_NAME != '' || 'voyageai')
              && format('{0}/{1}/{2}:{3}', env.ACR_REGISTRY, env.ACR_NAMESPACE, env.IMAGE_NAME || 'voyageai', github.sha)
              || format('voyageai/local:{0}', github.sha) }}"
