name: Build and Push Docker Image

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: {}

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
      ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
      IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      NEXT_PUBLIC_AMAP_WEB_KEY: ${{ secrets.NEXT_PUBLIC_AMAP_WEB_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun ACR
        if: ${{ env.ACR_REGISTRY != '' && env.ACR_USERNAME != '' && env.ACR_PASSWORD != '' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: ${{ env.ACR_REGISTRY != '' && env.ACR_USERNAME != '' && env.ACR_PASSWORD != '' }}
          tags: |
            ${{ env.ACR_REGISTRY && env.ACR_NAMESPACE && env.IMAGE_NAME
                && format('{0}/{1}/{2}:{3}', env.ACR_REGISTRY, env.ACR_NAMESPACE, env.IMAGE_NAME, github.sha)
                || format('voyageai/local:{0}', github.sha) }}
            ${{ env.ACR_REGISTRY && env.ACR_NAMESPACE && env.IMAGE_NAME
                && format('{0}/{1}/{2}:latest', env.ACR_REGISTRY, env.ACR_NAMESPACE, env.IMAGE_NAME)
                || 'voyageai/local:latest' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ env.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ env.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            NEXT_PUBLIC_AMAP_WEB_KEY=${{ env.NEXT_PUBLIC_AMAP_WEB_KEY }}

      - name: Print image reference
        run: |
          echo "Pushed tags prepared. Latest repo: ${{ env.ACR_REGISTRY && env.ACR_NAMESPACE && env.IMAGE_NAME
            && format('{0}/{1}/{2}', env.ACR_REGISTRY, env.ACR_NAMESPACE, env.IMAGE_NAME)
            || 'voyageai/local' }}"

